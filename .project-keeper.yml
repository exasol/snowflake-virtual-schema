sources:
  - type: maven
    path: pom.xml
    modules:
      - integration_tests
      - udf_coverage
      - jar_artifact
version:
  fromSource: pom.xml
build:
  runnerOs: ubuntu-22.04
  freeDiskSpace: false
  exasolDbVersions:
    - "8.34.0"
    # 7.1.x is disabled for now, more info: https://github.com/exasol/snowflake-virtual-schema/issues/20
  workflows:
    - name: ci-build.yml
      stepCustomizations:
        # Configure Snowflake credentials
        - action: INSERT_AFTER
          job: matrix-build
          stepId: enable-testcontainer-reuse
          content:
            name: Configure Snowflake credentials
            id: configure-snowflake-credentials
            run: |
              cat > test.properties <<EOL
              snowflake.username = ${{ secrets.USERNAME }}
              snowflake.accountname = ${{ secrets.ACCOUNTNAME }}
              snowflake.password = ${{ secrets.PASSWORD }}
              EOL
        - action: INSERT_AFTER
          job: matrix-build
          stepId: configure-snowflake-credentials
          content:
            name: Fix VM Crash in UDFs
            id: fix-vm-crash
            run: sudo sysctl -w kernel.apparmor_restrict_unprivileged_userns=0

    - name: release.yml
      stepCustomizations:
        # Configure Snowflake credentials
        - action: INSERT_AFTER
          stepId: verify-release
          content:
            name: Configure Snowflake credentials
            id: configure-snowflake-credentials
            run: |
              cat > test.properties <<EOL
              snowflake.username = ${{ secrets.USERNAME }}
              snowflake.accountname = ${{ secrets.ACCOUNTNAME }}
              snowflake.password = ${{ secrets.PASSWORD }}
              EOL
        - action: INSERT_AFTER
          job: release
          stepId: configure-snowflake-credentials
          content:
            name: Fix VM Crash in UDFs
            id: fix-vm-crash
            run: sudo sysctl -w kernel.apparmor_restrict_unprivileged_userns=0
